<div id="header-top" class="row g-0 justify-content-between">
  <!-- Mobile menu (dropdown) -->
  <div id="header-burger" class="nav col-3 d-flex d-lg-none justify-content-center" ngbDropdown>
    <button type="button" class="btn" ngbDropdownToggle aria-label="Open menu">
      <span class="material-icons">menu</span>
    </button>
    <ul ngbDropdownMenu>
      <li ngbDropdownItem>
        <a
          routerLink="/current"
          routerLinkActive="active"
          class="btn text-body text-decoration-none p-0"
        >
          <span class="material-icons">playlist_play</span>{{ 'play_list' | transloco }}
        </a>
      </li>
      <li class="dropdown-divider"></li>
      @if (!authStore.isAuthenticated()) {
      <li ngbDropdownItem>
        <button
          type="button"
          class="btn btn-link text-body text-decoration-none p-0"
          (click)="openModalRegister()"
        >
          <span class="material-icons">create_new_folder</span>{{ 'inscription' | transloco }}
        </button>
      </li>
      <li ngbDropdownItem>
        <button
          type="button"
          class="btn btn-link text-body text-decoration-none p-0"
          (click)="openModalLogin()"
        >
          <span class="material-icons">login</span>{{ 'connexion' | transloco }}
        </button>
      </li>
      }
      <li ngbDropdownItem>
        <a
          routerLink="/help"
          routerLinkActive="active"
          class="btn text-body text-decoration-none p-0"
        >
          <span class="material-icons">help</span>{{ 'help_title' | transloco }}
        </a>
      </li>
      @if (authStore.isAuthenticated()) {
      <li class="dropdown-divider"></li>
      <li ngbDropdownItem class="bg-primary text-white">
        {{ authStore.pseudo() }}
      </li>
      <li ngbDropdownItem>
        <a routerLink="/like" routerLinkActive="active" class="text-body text-decoration-none">
          <span class="material-icons">favorite</span>{{ 'mes_likes' | transloco }}
        </a>
      </li>
      <li ngbDropdownItem>
        <a
          routerLink="/my-playlists"
          routerLinkActive="active"
          class="text-body text-decoration-none"
        >
          <span class="material-icons">library_music</span>{{ 'mes_playlists' | transloco }}
        </a>
      </li>
      <li ngbDropdownItem>
        <a
          routerLink="/my-selection"
          routerLinkActive="active"
          class="text-body text-decoration-none"
        >
          <span class="material-icons">favorite</span>{{ 'ma_selection' | transloco }}
        </a>
      </li>
      <li ngbDropdownItem>
        <a routerLink="/settings" routerLinkActive="active" class="text-body text-decoration-none">
          <span class="material-icons">settings</span>{{ 'settings' | transloco }}
        </a>
      </li>
      <li class="dropdown-divider"></li>
      <li ngbDropdownItem>
        <button (click)="onLogout()" class="btn btn-link text-body text-decoration-none p-0">
          <span class="material-icons">power_settings_new</span>{{ 'deconnexion' | transloco }}
        </button>
      </li>
      }
    </ul>
  </div>

  <div id="header-logo" class="nav col-3">
    <a class="navbar-brand nav-item p-0" id="header-logo-link" alt="" routerLink="">
      <img
        [src]="
          authStore.isDarkMode()
            ? URL_ASSETS + 'assets/img/logo_dark.png'
            : URL_ASSETS + 'assets/img/logo.png'
        "
        [alt]="'home' | transloco"
        height="50"
        width="199"
        class="d-none d-lg-block mx-auto"
      />
      <img
        [src]="
          authStore.isDarkMode()
            ? URL_ASSETS + 'assets/img/logo_mobile_dark.png'
            : URL_ASSETS + 'assets/img/logo_mobile.png'
        "
        [alt]="'home' | transloco"
        class="d-lg-none"
      />
    </a>
  </div>

  <ul class="nav col-5 d-none d-lg-flex" id="header-nav">
    @if(authStore.isAuthenticated()) {
    <li class="nav-item align-self-center d-flex" ngbDropdown>
      <a id="header-toggle-big" class="btn btn-light" ngbDropdownToggle>
        {{ authStore.pseudo() }} <span class="caret"></span>
      </a>
      <ul ngbDropdownMenu>
        <li ngbDropdownItem>
          <a routerLink="/like" routerLinkActive="active" class="text-body text-decoration-none">
            <span class="material-icons">favorite</span>{{ 'mes_likes' | transloco }}
          </a>
        </li>
        <li ngbDropdownItem>
          <a
            routerLink="/my-playlists"
            routerLinkActive="active"
            class="text-body text-decoration-none"
          >
            <span class="material-icons">library_music</span>{{ 'mes_playlists' | transloco }}
          </a>
        </li>
        <li ngbDropdownItem>
          <a
            routerLink="/my-selection"
            routerLinkActive="active"
            class="text-body text-decoration-none"
          >
            <span class="material-icons">favorite</span>{{ 'ma_selection' | transloco }}
          </a>
        </li>
        <li ngbDropdownItem>
          <a
            routerLink="/settings"
            routerLinkActive="active"
            class="text-body text-decoration-none"
          >
            <span class="material-icons">settings</span>{{ 'settings' | transloco }}
          </a>
        </li>
        <li class="dropdown-divider"></li>
        <li ngbDropdownItem>
          <button (click)="onLogout()" class="btn btn-link text-body text-decoration-none p-0">
            <span class="material-icons">power_settings_new</span>{{ 'deconnexion' | transloco }}
          </button>
        </li>
      </ul>
    </li>
    } @else{
    <li id="header-li-inscription" class="nav-item align-self-center d-flex d-none d-lg-block">
      <button
        type="button"
        class="btn btn-warning btn-outline-warning text-light"
        (click)="openModalRegister()"
      >
        {{ 'inscription' | transloco }}
      </button>
    </li>
    <li id="header-li-connexion" class="nav-item align-self-center d-flex d-none d-lg-block">
      <button type="button" class="btn btn-primary text-light" (click)="openModalLogin()">
        {{ 'connexion' | transloco }}
      </button>
    </li>
    }

    <li id="header-li-help" class="nav-item align-self-center d-flex">
      <a class="btn btn-light" routerLink="/help">
        <span class="material-icons">help</span>
      </a>
    </li>
  </ul>

  <div id="header-recherche" class="navbar-form navbar-right col-4 my-auto">
    <app-search-bar></app-search-bar>
  </div>
</div>

<div
  id="header-player"
  class="row g-0"
  [class.expanded]="isPlayerExpanded()"
  appSwipeDown
  (swipeDown)="collapsePlayer()"
>
  <button id="header-player-collapse" class="btn btn-link" (click)="collapsePlayer()">
    <span class="material-icons">keyboard_arrow_down</span>
  </button>

  <div id="player-info-left" class="col-md-3 pl-2 pt-2">
    @if(authStore.isAuthenticated() && userLibraryService.isLiked(queueStore.currentKey())){
    <button
      id="player-info-left-liked"
      class="btn btn-sm btn-link text-decoration-none float-end"
      (click)="
        $event.stopPropagation(); userLibraryService.removeLike(queueStore.currentKey()).subscribe()
      "
    >
      <span class="material-icons">favorite</span>
    </button>
    } @if(authStore.isAuthenticated() && !userLibraryService.isLiked(queueStore.currentKey())){
    <button
      id="player-info-left-like"
      class="btn btn-sm btn-link text-decoration-none text-body float-end"
      (click)="
        $event.stopPropagation(); userLibraryService.addLike(queueStore.currentKey()).subscribe()
      "
    >
      <span class="material-icons">favorite_border</span>
    </button>
    } @if(queueStore.currentKey()){
    <img
      [src]="'https://img.youtube.com/vi/' + queueStore.currentKey() + '/mqdefault.jpg'"
      class="float-start"
      alt=""
    />
    }
    <div>
      <b>{{ queueStore.currentVideo()?.titre }}</b>
    </div>
    <div>{{ queueStore.currentVideo()?.artiste }}</div>
  </div>

  <div id="player-info-center" class="col-md-6">
    <div class="pl-lg-5 pr-lg-5 ml-lg-5 mr-lg-5">
      <button
        type="button"
        id="player-info-center-title"
        class="btn btn-light d-inline-block d-md-none"
        (click)="expandPlayer()"
      >
        <div>
          <b>{{ queueStore.currentVideo()?.titre }}</b>
        </div>
        <div>{{ queueStore.currentVideo()?.artiste }}</div>
      </button>

      <div class="btn-group btn-group-sm">
        <button
          type="button"
          class="btn text-light w-100 d-none d-md-block"
          [class.disabled]="
            !queueStore.hasPrevious() && playerStore.currentTimeFormatted() === '0:00'
          "
          [class.border-0]="
            !queueStore.hasPrevious() && playerStore.currentTimeFormatted() === '0:00'
          "
          (click)="onBefore()"
        >
          <span class="material-icons">skip_previous</span>
        </button>
        <button type="button" id="play-button" class="btn text-light" (click)="onPlayPause()">
          @if(playerStore.isPlaying()){
          <span class="material-icons">pause</span>
          }@else{
          <span class="material-icons">play_arrow</span>
          }
        </button>
        <button
          type="button"
          class="btn text-light w-100 d-none d-md-block"
          [class.disabled]="!queueStore.hasNext()"
          [class.border-0]="!queueStore.hasNext()"
          (click)="onAfter()"
        >
          <span class="material-icons">skip_next</span>
        </button>
      </div>

      <div
        id="player-info-center-more-actions"
        class="btn-group btn-group-sm float-end d-none d-md-block"
      >
        <button
          type="button"
          class="btn text-light"
          (click)="goFullscreen('player')"
          placement="top"
          ngbTooltip="{{ 'video_plein_ecran' | transloco }}"
        >
          <span class="material-icons">fullscreen</span>
        </button>
        <button
          type="button"
          id="repeat"
          class="btn text-light"
          [class.active]="playerStore.isRepeat()"
          (click)="repeat()"
          placement="top"
          ngbTooltip="{{ 'repetition' | transloco }}"
        >
          <span class="material-icons">repeat</span>
        </button>
        <button
          type="button"
          id="random"
          class="btn text-light"
          [class.active]="queueStore.isShuffled()"
          (click)="random()"
          placement="top"
          ngbTooltip="{{ 'lecture_aleatoire' | transloco }}"
        >
          <span class="material-icons">shuffle</span>
        </button>
      </div>
    </div>

    <div id="header-player-center-load">
      <div id="current-time">{{ playerStore.currentTimeFormatted() }}</div>
      <div id="slider-1-main">
        <div
          id="slider-1-content"
          class="ui-slider"
          tabindex="0"
          (click)="onClickSliderPlayer($event)"
          (keydown.enter)="$event.preventDefault()"
          (keydown.space)="$event.preventDefault()"
          #contentSlider1
        >
          @if(isBrowser){
          <span
            class="ui-slider-handle"
            #sliderPlayer
            [style.left.%]="playerStore.progress()"
            ngDraggable
            [bounds]="contentSlider1"
            [inBounds]="true"
            lockAxis="y"
            [preventDefaultEvent]="true"
            (movingOffset)="onDragMovingPlayer($event)"
            (endOffset)="onDragEndPlayer($event)"
          ></span>
          }
        </div>
        <div id="load-video" [style.width.%]="playerStore.loadedProgress()"></div>
        <div id="load-video-current" [style.width.%]="playerStore.progress()"></div>
      </div>
      <div id="chrono-total">{{ playerStore.durationFormatted() }}</div>
    </div>
  </div>

  <div id="player-info-right" class="col-md-3 my-auto">
    <div id="header-player-volume-content" class="mx-auto">
      <span class="material-icons text-light">volume_up</span>
      <div id="slider-2-main">
        <div
          id="slider-2-content"
          class="ui-slider"
          tabindex="0"
          (click)="onClickSliderVolume($event)"
          (keydown.enter)="$event.preventDefault()"
          (keydown.space)="$event.preventDefault()"
          #contentSlider2
        >
          @if(isBrowser) {
          <span
            class="ui-slider-handle"
            #sliderVolume
            [style.left.%]="playerStore.volume()"
            ngDraggable
            [bounds]="contentSlider2"
            [inBounds]="true"
            lockAxis="y"
            [preventDefaultEvent]="true"
            (movingOffset)="onDragMovingVolume($event)"
            (endOffset)="onDragEndVolume($event)"
          ></span>
          }
        </div>
        <div id="load-volume-current" [style.width.%]="playerStore.volume()"></div>
      </div>
    </div>
  </div>
</div>

<ng-template #contentModalRegister let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ 'inscription' | transloco }}</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <p class="bg-info p-2 rounded">{{ 'inscription_description' | transloco }}</p>
    <div id="google-register-button-header" class="my-3"></div>
    <div class="d-flex align-items-center my-3">
      <hr class="flex-grow-1" />
      <span class="mx-2">
        {{ 'or' | transloco }}
      </span>
      <hr class="flex-grow-1" />
    </div>
    @if(!isRegistered()){
    <form (submit)="onSubmitRegister($event)">
      <div class="form-floating mb-3">
        <input
          type="text"
          id="pseudo"
          class="form-control"
          [placeholder]="'pseudo' | transloco"
          ngbAutofocus
          [formField]="registerForm.pseudo"
        />
        <label for="pseudo">{{ 'pseudo' | transloco }}</label>
      </div>
      <div class="form-floating mb-3">
        <input
          type="email"
          id="mailLogin"
          class="form-control"
          [placeholder]="'mail' | transloco"
          [formField]="registerForm.mail"
        />
        <label for="mailLogin">{{ 'mail' | transloco }}</label>
      </div>
      <div class="form-floating mb-3">
        <input
          type="password"
          id="password"
          class="form-control"
          [placeholder]="'mot_de_passe' | transloco"
          [formField]="registerForm.password"
        />
        <label for="password">{{ 'mot_de_passe' | transloco }}</label>
      </div>
      <p>
        <input
          type="submit"
          class="btn btn-primary"
          [disabled]="registerForm().invalid()"
          value="{{ 'je_m_inscris' | transloco }}"
        />
      </p>
      @if(registerForm().dirty() && error()!=='') {
      <p class="alert alert-danger">{{ error() }}</p>
      }
    </form>
    } @else {
    <div>
      <p class="alert alert-success">{{ 'inscription_succes' | transloco }}</p>
      <p>
        <button
          type="button"
          (click)="dismissAndOpenLogin(modal)"
          class="btn btn-link text-decoration-underline p-0"
        >
          {{ 'connexion' | transloco }}
        </button>
      </p>
    </div>
    }
  </div>
</ng-template>

<ng-template #contentModalLogin let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ 'connexion' | transloco }}</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <div id="google-signin-button-header" class="my-3"></div>
    <div class="d-flex align-items-center my-3">
      <hr class="flex-grow-1" />
      <span class="mx-2">
        {{ 'or' | transloco }}
      </span>
      <hr class="flex-grow-1" />
    </div>
    <form (submit)="onLogIn($event, modal, '')">
      <div class="form-floating mb-3">
        <input
          type="text"
          id="pseudoLogin"
          class="form-control"
          [placeholder]="'pseudo_ou_mail' | transloco"
          ngbAutofocus
          [formField]="loginForm.pseudo"
        />
        <label for="pseudoLogin">{{ 'pseudo_ou_mail' | transloco }}</label>
      </div>
      <div class="form-floating mb-3">
        <input
          type="password"
          id="passwordLogin"
          class="form-control"
          [placeholder]="'mot_de_passe' | transloco"
          [formField]="loginForm.password"
        />
        <label for="passwordLogin">{{ 'mot_de_passe' | transloco }}</label>
      </div>
      <p>
        <input
          type="submit"
          class="btn btn-primary"
          [disabled]="loginForm().invalid()"
          value="{{ 'connexion' | transloco }}"
        />
      </p>
      @if(loginForm().dirty() && error()!==''){
      <p class="alert alert-danger">{{ error() }}</p>
      }

      <p>
        <button
          type="button"
          (click)="dismissAndOpenModal(modal, contentModalNewPass)"
          class="btn btn-link text-decoration-underline p-0"
        >
          {{ 'mot_de_passe_oublie' | transloco }}
        </button>
      </p>
    </form>
  </div>
</ng-template>

<ng-template #contentModalNewPass let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ 'mot_de_passe_oublie' | transloco }}</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    @if(!isSuccess()){
    <form (submit)="onSubmitResetPass($event)">
      <div class="form-floating mb-3">
        <input
          type="email"
          id="mailReset"
          class="form-control"
          [placeholder]="'mail' | transloco"
          ngbAutofocus
          [formField]="resetPassForm.mail"
        />
        <label for="mailReset">{{ 'mail' | transloco }}</label>
      </div>
      <p>
        <input
          type="submit"
          class="btn btn-primary"
          [disabled]="resetPassForm().invalid()"
          value="{{ 'envoyer' | transloco }}"
        />
      </p>
      @if(resetPassForm().dirty() && error()!=='') {
      <p class="alert alert-danger">{{ error() }}</p>
      }
    </form>
    } @else {
    <p class="alert alert-success">{{ 'mail_pass_envoye_succes' | transloco }}</p>
    }
  </div>
</ng-template>

<ng-template #contentModalAddVideo let-modal>
  <div class="modal-header">
    <h4 class="modal-title">{{ 'ajouter_musique_playlist' | transloco }}</h4>
    <button
      type="button"
      class="btn-close"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <p>{{ 'ajouter' | transloco }}: {{ addTitle }} {{ addArtist }}</p>
    @if(error()!==''){
    <p class="alert alert-danger">{{ error() }}</p>
    } @if (userDataStore.playlists().length===0) {
    <div class="bg-info p-2 rounded">
      {{ 'ajouter_musique_playlist_empty' | transloco }}
    </div>
    }
    <table class="table">
      @for (playlist of userDataStore.playlists(); track playlist.id_playlist) {
      <tr>
        <td>
          <button class="btn btn-link" (click)="onAddVideo(playlist.id_playlist, modal)">
            {{ playlist.titre }}
          </button>
        </td>
      </tr>
      }
    </table>
  </div>
</ng-template>

<!-- Mobile Offcanvas Menu -->
<ng-template #contentMobileMenu>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="offcanvas-mobile-menu-title">{{ 'menu' | transloco }}</h5>
    <button type="button" class="btn-close" aria-label="Close" (click)="closeMobileMenu()"></button>
  </div>
  <div class="offcanvas-body">
    <nav class="nav flex-column gap-2">
      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/current"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">playlist_play</span>
        {{ 'play_list' | transloco }}
      </a>

      <hr class="my-2" />

      @if (!authStore.isAuthenticated()) {
      <button
        type="button"
        class="nav-link d-flex align-items-center gap-2 btn btn-link text-start p-0"
        (click)="closeMobileMenu(); openModalRegister()"
      >
        <span class="material-icons">create_new_folder</span>
        {{ 'inscription' | transloco }}
      </button>
      <button
        type="button"
        class="nav-link d-flex align-items-center gap-2 btn btn-link text-start p-0"
        (click)="closeMobileMenu(); openModalLogin()"
      >
        <span class="material-icons">login</span>
        {{ 'connexion' | transloco }}
      </button>
      }

      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/help"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">help</span>
        {{ 'help_title' | transloco }}
      </a>

      @if (authStore.isAuthenticated()) {
      <hr class="my-2" />

      <div class="nav-link bg-primary text-white rounded px-3 py-2 fw-bold">
        {{ authStore.pseudo() }}
      </div>

      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/like"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">favorite</span>
        {{ 'mes_likes' | transloco }}
        @if (userDataStore.likedVideoCount() > 0) {
        <span class="badge bg-secondary ms-auto">{{ userDataStore.likedVideoCount() }}</span>
        }
      </a>
      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/my-playlists"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">library_music</span>
        {{ 'mes_playlists' | transloco }}
        @if (userDataStore.playlistCount() > 0) {
        <span class="badge bg-secondary ms-auto">{{ userDataStore.playlistCount() }}</span>
        }
      </a>
      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/my-selection"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">favorite</span>
        {{ 'ma_selection' | transloco }}
        @if (userDataStore.followCount() > 0) {
        <span class="badge bg-secondary ms-auto">{{ userDataStore.followCount() }}</span>
        }
      </a>
      <a
        class="nav-link d-flex align-items-center gap-2"
        routerLink="/settings"
        (click)="closeMobileMenu()"
      >
        <span class="material-icons">settings</span>
        {{ 'settings' | transloco }}
      </a>

      <hr class="my-2" />

      <button
        type="button"
        class="nav-link d-flex align-items-center gap-2 btn btn-link text-start text-danger p-0"
        (click)="closeMobileMenu(); onLogout()"
      >
        <span class="material-icons">power_settings_new</span>
        {{ 'deconnexion' | transloco }}
      </button>
      }
    </nav>
  </div>
</ng-template>
